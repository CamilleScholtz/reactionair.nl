{{ $apiUrl := (cond (ne (.apiUrl) nil) .apiUrl "https://welcomments.io/api") }}
{{ $websiteId := .websiteId }}
{{ $slug := index (last 1 (split (delimit (split .context.RelPermalink "/") "," "") ",")) 0 }}
{{ $slug = cond (ne (eq $slug "")) $slug "___root___" }}

<div id="welcomments__container" class="welcomments__container">
  {{ $allComments := dict }}
	{{ if isset .context.Site.Data.welcomments $slug }}
		{{ $allComments = index .context.Site.Data.welcomments $slug }}
	{{ end }}

	{{ if eq $allComments 0 }}
		<h3 id="welcomments__comment-count-title" class="welcomments__comments-title">Nog geen reacties...</h3>
	{{ end }}

	<section id="welcomments__comment-container" class="welcomments__comment-container">
		{{- range $allComments -}}
			{{- if eq (index . "replying_to") nil -}}
				{{- $data := dict -}}
				{{- $data  = merge $data (dict "nestingLevel" 0) -}}
				{{- $data  = merge $data (dict "allComments" $allComments) -}}
				{{- $data  = merge $data (dict "comment" .) -}}
				{{- $data  = merge $data (dict "apiUrl" $apiUrl) -}}
				{{- $data  = merge $data (dict "websiteId" $websiteId) -}}
				{{- partial "welcomments/single_comment" $data -}}
			{{- end -}}
		{{- end -}}
	</section>

	{{- $data := dict -}}
	{{- $data  = merge $data (dict "apiUrl" $apiUrl) -}}
	{{- $data  = merge $data (dict "websiteId" $websiteId) -}}
	{{- $data  = merge $data (dict "permalink" .context.Permalink) -}}
	{{- $data  = merge $data (dict "slug" $slug) -}}
	{{ partial "welcomments/comment_form" $data }}
</div>

<script defer id="welcomments__script" src="https://cdn.welcomments.io/welcomments.js" type="text/javascript"></script>
<script type="text/javascript">
	welcomments = {
		apiUrl: {{ $apiUrl }},

		commentCountTitleFactory: function (commentCount) {
			if (commentCount === 0) {
				return "Nog geen reacties...";
			}
			return "";
		},

		placeholderCommentFactory: function (comment) {
			var year      = new Intl.DateTimeFormat("en", {year: "numeric"}).format(comment.date);
			var month     = new Intl.DateTimeFormat("en", {month: "long"}).format(comment.date);
			var day       = new Intl.DateTimeFormat("en", {day: "2-digit"}).format(comment.date);

			{{ $template := dict }}
			{{- $template = merge $template (dict "id" "${comment.id}") -}}
			{{- $template = merge $template (dict "elementId" "welcomments__comment-${comment.id}") -}}
			{{- $template = merge $template (dict "elementClassName" "welcomments__comment") -}}
			{{- $template = merge $template (dict "nestingLevel" 0) -}}
			{{- $template = merge $template (dict "formattedDate" "${month} ${day}, ${year}") -}}
			{{- $template = merge $template (dict "dateXmlSchema" "${comment.date}") -}}
			{{- $template = merge $template (dict "authorName" "${comment.author.name}") -}}
			{{- $template = merge $template (dict "message" "${comment.message}") -}}
			{{- $template = merge $template (dict "apiUrl" $apiUrl) -}}
			{{- $template = merge $template (dict "websiteId" $websiteId) -}}

			return `{{ safeJS (partial "welcomments/template.html" $template) }}`;
		},
	};
</script>
