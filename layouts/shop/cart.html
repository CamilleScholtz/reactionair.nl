{{ define "main" }}
	<div id="taxonomy" class="cart-page">
		<ul
			id="products"
			x-data="{
				init() {
					console.log($store.cart.contents);
				}
			}"
		>
			<div
				class="cart-empty"
				x-cloak
				x-show="!$store.cart.contents.length"
			>
				<p>Uw winkelwagen is leeg.</p>
				<p>Ga <a href="/winkel/producten/boeken">terug naar de winkel</a>.</p>
			</div>

			{{ range $product := (where (where .Site.RegularPages "Section" "shop") "Params.out_of_stock" "!=" true).ByDate.Reverse }}
				{{ range .Params.variants }}
					{{ if .out_of_stock }}
						{{ continue }}
					{{ end }}

					<template x-if="$store.cart.contents.some(p => p.variant === {{ .id }})">
						{{ partial "shop/product.html" (dict
							"product"  $product
							"variant"  .
							"checkout" true
						) }}
					</template>
				{{ end }}
			{{ end }}
		</ul>

		<div class="info">
			<a href="/winkel/afrekenen" class="button">Afrekenen</a>

			<div
				class="prices"
				x-data="{
					shipping:   null,
					estimation: 2,
					total:      null,
				}"
				x-init="fetch('{{ .Site.Params.api }}/api/shop/shipping', {
						method: 'POST',
						headers: {
							'Content-Type': 'application/json'
						},
						body: JSON.stringify({
							cart: $store.cart.contents,
						})
					})
						.then(response => response.json())
						.then(data => {
							const formatter = value => $store.cart.currency(value, { symbol: 'â‚¬ ', separator: '.' });

							shipping   = formatter(data.price);
							estimation = data.estimation;
							total      = formatter(0);

							$store.cart.contents.forEach(variant => {
								total = total.add(formatter(variant.price).multiply(variant.quantity));
							});
						})"
			>
				<div class="total" x-text="total?.format()"></div>
				<div>
					<small class="free-shipping">
						(Verzendkosten, uiterlijk binnen <small x-text="estimation"></small> werkdagen in huis)
					</small>
					<span class="shipping" x-text="shipping?.format()"></span>
				</div>
				<div class="total-plus-shipping" x-text="total?.add(shipping.price).format()"></div>
			</div>
		</div>
	</div>
{{ end }}
