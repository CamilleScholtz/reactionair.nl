<!DOCTYPE html>

<html>
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Inhoudsbeheer</title>

		<script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
	</head>

	<body>
		<script src="https://unpkg.com/netlify-cms@^2.0.0/dist/netlify-cms.js"></script>

		<script type="application/javascript">
			if (window.netlifyIdentity) {
				window.netlifyIdentity.on("init", (user) => {
					if (!user) {
						window.netlifyIdentity.on("login", () => {
							document.location.href = "/admin/";
						});
					}
				});
			}

			CMS.registerEditorComponent({
				id:    "image",
				label: "Afbeelding",

				fields: [{
					name:   "caption",
					label:  "Onderschrift",
					widget: "string",
				},
				{
					name:     "license",
					label:    "Bronvermelding",
					widget:   "string",
					required: false,
				},
				{
					name:     "src",
					label:    "Afbeelding naam",
					hint:     "De standaardwaarde is de ge√ºploade afbeelding.",
					widget:   "string",
					required: false,
				}],

				pattern: /^{{< image\n?(?:\ssrc="(?<src>.*)")?\n?(?:\scaption="(?<caption>.*)")\n?(?:\slicense="(?<license>.*)")?\s?>}}/,

				fromBlock: (match) => {
					return {
						caption: match.groups.caption,
						...(typeof match.groups.license === 'string' && {license: match.groups.license}),
						...(typeof match.groups.src     === 'string' && {src: match.groups.src}),
					};
				},

				toBlock: (obj) => {
					let prefix  = " ";
					let postfix = " ";
					let src     = "";
					let license = "";

					if (obj.src) {
						prefix  = "\n\t";
						postfix = "\n";
						src     = `\n\tsrc="${obj.src}`;
					}
					if (obj.license) {
						prefix  = "?\n\t";
						postfix = "\n";
						article = `\n\tlicense="${obj.license}"`;
					}
				
					return `{{< image${prefix}caption="${obj.caption}"${src}${license}${postfix}>}}`;
				},
			});

			CMS.registerEditorComponent({
				id:    "twitter",
				label: "Twitter",

				fields: [{
					name:   "user",
					label:  "Gebruiker",
					widget: "string",
				},
				{
					name:   "id",
					label:  "Tweet ID",
					widget: "string",
				}],

				pattern: /^{{< tweet ([A-Za-z0-9]+) ([0-9]+) >}}/,

				fromBlock: (match) => {
					return {
						user: match[1],
						id:   match[2],
					};
				},

				toBlock: (obj) => {
					return `{{< tweet ${obj.user} ${obj.id} >}}`;
				},
			});

			CMS.registerEditorComponent({
				id:    "quote",
				label: "Citaat",

				fields: [{
					name:   "text",
					label:  "Citaat",
					widget: "string",
				},
				{
					name:   "author",
					label:  "Auteur",
					widget: "string",
				}],

				pattern: /^{{< quote\n?(?:\stext="(?<text>.*)")\n?(?:\sauthor="(?<author>.*)")\n?\s?>}}/,
				
				fromBlock: (match) => {
					return {
						text:    match.groups.text,
						author:  match.groups.author,
					};
				},

				toBlock: (obj) => {
					return `{{< quote\n\ttext="${obj.text}"\n\tauthor="${obj.author}"\n>}}`;
				},
			});

			CMS.registerEditorComponent({
				id:    "youtube",
				label: "Youtube",

				fields: [{
					name:   "id",
					label:  "Video ID",
					widget: "string"
				}],

				pattern: /^{{< youtube\s+(?<id>[A-Za-z0-9\-]+)\s+>}}/,

				fromBlock: (match) => {
					return {
						id: match[1]
					};
				},

				toBlock: (obj) => {
					return `{{< youtube ${obj.id} >}}`;
				},
			});

			CMS.registerEditorComponent({
				id:    "boekencast",
				label: "Boekencast",

				fields: [{}],

				pattern: /^{{< boekencast >}}/,

				fromBlock: (match) => {
					return { };
				},

				toBlock: (obj) => {
					return `{{< boekencast >}}`;
				},
			});
		</script>
	</body>

	<!-- See: https://github.com/netlify/netlify-cms/issues/441 -->
	<link rel="stylesheet" href="style.css">

	<!-- See: https://github.com/netlify/netlify-cms/issues/4646 -->
	<script>
		var ArrayControl = createClass({
			handleChange: function (e) {
				const separator = this.props.field.get("separator", ", ");
				this.props.onChange(e.target.value.split(separator));
			},

			render: function () {
				const separator = this.props.field.get("separator", ", ");
				var value = this.props.value;
				
				return h("input", {
					id: this.props.forID,
					className: this.props.classNameWrapper,
					type: "text",
					value: value ? value.join(separator) : "",
					onChange: this.handleChange,
				});
			},
		});

		var ArrayPreview = createClass({
			render: function () {
				return h(
					"ul",
					{},
					this.props.value.map(function (val, index) {
						return h("li", { key: index }, val);
					})
			);
			},
		});

		var schema = {
			properties: {
				separator: { type: "string" },
			},
		};

		CMS.registerWidget("array", ArrayControl, ArrayPreview, schema);
	</script>
</html>
